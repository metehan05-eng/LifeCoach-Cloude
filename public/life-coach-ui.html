<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeCoach AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0F766E', // Teal-700
                        secondary: '#CCFBF1', // Teal-100
                        accent: '#F0FDFA', // Teal-50
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        @keyframes star-upgrade {
            0% { transform: scale(1) rotate(0deg); color: #FBBF24; }
            50% { transform: scale(1.5) rotate(180deg); color: #FEF9C3; }
            100% { transform: scale(1) rotate(360deg); color: #FBBF24; }
        }
        .star-upgraded { animation: star-upgrade 0.6s ease-in-out; }
        
        /* DÃ¼ÅŸÃ¼nce Balonu Stili */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-screen flex overflow-hidden font-sans text-slate-800 dark:text-gray-100 transition-colors duration-200">

    <!-- Sidebar -->
    <aside id="main-sidebar" class="w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-col hidden md:flex shadow-sm z-10 transition-colors duration-200">
        <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white">
                <i class="fa-solid fa-leaf text-lg"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800 dark:text-white tracking-tight">LifeCoach AI</h1>
        </div>

        <div class="p-4">
            <button onclick="startNewChat()" class="w-full bg-primary hover:bg-teal-800 text-white py-3 px-4 rounded-xl shadow-sm transition-all flex items-center justify-center gap-2 font-medium">
                <i class="fa-solid fa-plus"></i>
                Yeni Oturum
            </button>
            <button onclick="exportChat()" class="w-full mt-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 py-3 px-4 rounded-xl shadow-sm transition-all flex items-center justify-center gap-2 font-medium text-sm">
                <i class="fa-solid fa-download"></i>
                Sohbeti indir (.txt)
            </button>
        </div>

        <!-- Discipline Badge -->
        <div class="px-4 py-2">
            <div id="discipline-badge" class="bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 rounded-xl p-4 text-center hidden">
                <div class="flex justify-center items-center gap-2 mb-2">
                    <i class="fa-solid fa-shield-halved text-primary"></i>
                    <h3 class="font-bold text-gray-800 dark:text-white">DISCIPLINE CORE</h3>
                </div>
                <div id="badge-stars" class="flex justify-center text-xl text-amber-400 mb-3">
                    <!-- Stars will be injected here -->
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Mevcut Seri: <span id="badge-streak" class="font-bold">0</span> gÃ¼n</p>
                <button id="checkin-btn" onclick="handleCheckIn()" class="w-full bg-white dark:bg-gray-700 text-primary dark:text-white text-sm font-semibold py-2 px-4 rounded-lg border border-primary/50 hover:bg-primary/10 dark:hover:bg-gray-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-transparent">
                    <i class="fa-solid fa-calendar-check mr-1"></i> GÃ¼nlÃ¼k Check-in
                </button>
            </div>
        </div>

        <div class="px-4 pb-2">
            <div class="relative">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                <input type="text" id="history-search" onkeyup="filterHistory()" placeholder="GeÃ§miÅŸi ara..." class="w-full bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg pl-8 pr-3 py-2 text-sm border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-4 space-y-2" id="history-list">
            <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-2">GeÃ§miÅŸ Oturumlar</div>
            <!-- History items will be injected here -->
        </div>

        <div class="p-4 border-t border-gray-100 dark:border-gray-700" id="auth-container">
            <!-- JS ile doldurulacak -->
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col relative bg-white md:bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
        <!-- Mobile Header -->
        <header class="md:hidden bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 flex items-center justify-between sticky top-0 z-20">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white">
                    <i class="fa-solid fa-leaf text-sm"></i>
                </div>
                <span class="font-bold text-gray-800">LifeCoach AI</span>
            </div>
            <button onclick="toggleSidebar()" class="text-gray-500 hover:text-gray-700">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
            <!-- Welcome Message -->
            <div class="flex flex-col items-center justify-center h-full text-center space-y-4" id="welcome-screen">
                <div class="w-16 h-16 bg-secondary rounded-2xl flex items-center justify-center mb-2">
                    <i class="fa-solid fa-hands-holding-circle text-3xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Merhaba, bugÃ¼n nasÄ±lsÄ±n?</h2>
                <p class="text-gray-500 dark:text-gray-400 max-w-md">KiÅŸisel yaÅŸam koÃ§unuz olarak buradayÄ±m. Hedefleriniz, endiÅŸeleriniz hakkÄ±nda veya sadece sohbet etmek iÃ§in bana yazabilirsiniz.</p>
                
                <!-- Prompt Templates (Referencing the context of prompt-templates) -->
                <div id="dynamic-prompts" class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-2xl mt-8">
                    <!-- Javascript ile rastgele doldurulacak -->
                </div>
            </div>
            
            <!-- Messages will be appended here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 md:m-4 md:rounded-2xl md:shadow-lg md:border-none transition-colors duration-200">
            <!-- File Preview -->
            <div id="file-preview-container" class="hidden mb-2 p-2 border border-gray-200 dark:border-gray-600 rounded-lg relative inline-flex items-center gap-3 bg-gray-50 dark:bg-gray-700/50">
                <!-- JS ile doldurulacak -->
            </div>

            <form id="chat-form" class="relative flex items-end gap-2">
                <div class="relative flex-1">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Buraya yazÄ±n veya bir dosya ekleyin..."
                        class="w-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white dark:placeholder-gray-400 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:bg-white dark:focus:bg-gray-600 transition-all resize-none max-h-32"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                    ></textarea>
                    <!-- File Upload Button -->
                    <button type="button" onclick="document.getElementById('file-upload').click()" class="absolute right-10 bottom-3 text-gray-400 hover:text-primary transition-colors" title="Dosya YÃ¼kle">
                        <i class="fa-solid fa-paperclip"></i>
                    </button>
                    <button type="button" id="mic-btn" onclick="toggleDictation()" class="absolute right-3 bottom-3 text-gray-400 hover:text-gray-600 transition-colors" title="Voice Type">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                </div>
                <button type="submit" class="bg-primary hover:bg-teal-800 text-white rounded-xl w-12 h-12 flex items-center justify-center shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed" id="send-btn">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
            <input type="file" id="file-upload" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" class="hidden" onchange="handleFileSelect(this)">
            <div class="text-center mt-2">
                <p class="text-xs text-gray-400">LifeCoach AI kiÅŸisel geliÅŸim amaÃ§lÄ±dÄ±r ve tÄ±bbi tavsiye saÄŸlamaz.</p>
            </div>
        </div>
    </main>

    <script>
        // Sayfa yÃ¼klenirken gÃ¼venlik kontrolÃ¼: Token yoksa Login'e at
        if (!localStorage.getItem('token')) {
            window.location.href = '/login';
        }

        function escapeJS(str) {
            if (str === null || str === undefined) return '';
            // onclick iÃ§erisindeki string'i bozacak karakterlerden kaÃ§Ä±ÅŸ
            return String(str).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '');
        }

        let chatContainer;
        let chatForm;
        let userInput;
        let welcomeScreen;
        let messageHistory = [];
        let currentSessionId = null;
        let currentFile = null; // { data, name, type }
        
        // GÃ¼venli LocalStorage EriÅŸimi
        const storage = {
            get: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
            set: (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} },
            remove: (key) => { try { localStorage.removeItem(key); } catch(e) {} },
            has: (key) => { try { return key in localStorage; } catch(e) { return false; } }
        };

        // Tema YÃ¶netimi
        function initTheme() {
            const theme = storage.get('theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        initTheme();

        let welcomeShown = false;

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            toast.className = 'bg-white dark:bg-gray-800 text-gray-800 dark:text-white px-4 py-3 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 flex items-center gap-3 transform transition-all duration-500 translate-x-full opacity-0 pointer-events-auto min-w-[200px]';
            toast.innerHTML = `<p class="font-medium text-sm flex items-center gap-2">${message}</p>`;
            
            container.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });
            
            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => { toast.remove(); }, 500);
            }, 3000);
        }

        // Helper: GÃ¼venli JSON parse
        function getSafeUser() {
            try {
                return JSON.parse(storage.get('user'));
            } catch (e) {
                return null;
            }
        }

        // Auth KontrolÃ¼
        function checkAuth() {
            const user = getSafeUser();
            const token = storage.get('token');
            const authContainer = document.getElementById('auth-container');
            
            if (user && token) {
                const avatarHtml = user.avatar 
                    ? `<img src="${user.avatar}" alt="${user.name}" class="w-9 h-9 rounded-full object-cover border border-gray-200 dark:border-gray-600">`
                    : `<div class="w-9 h-9 rounded-full bg-primary text-white flex items-center justify-center font-bold">${user.name.charAt(0).toUpperCase()}</div>`;

                authContainer.innerHTML = `
                    <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 group relative transition-colors">
                        ${avatarHtml}
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${user.name}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">@${user.name}</p>
                            <p class="text-xs text-gray-500 truncate">${user.email}</p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="toggleDarkMode()" class="p-1.5 text-gray-400 hover:text-yellow-500 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" title="Dark Mode">
                                <i class="fa-solid ${document.documentElement.classList.contains('dark') ? 'fa-sun' : 'fa-moon'}"></i>
                            </button>
                            <button onclick="openSettings()" class="p-1.5 text-gray-400 hover:text-primary rounded-md hover:bg-gray-100 transition-colors" title="Settings">
                                <i class="fa-solid fa-gear"></i>
                            </button>
                            <button onclick="logout()" class="p-1.5 text-gray-400 hover:text-red-500 rounded-md hover:bg-gray-100 transition-colors" title="Logout">
                                <i class="fa-solid fa-right-from-bracket"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                if (!welcomeShown) {
                    showToast(`HoÅŸ geldin, ${user.name}! ðŸ‘‹âœ¨`);
                    welcomeShown = true;
                }
                loadHistory(); // KullanÄ±cÄ± giriÅŸ yaptÄ±ysa geÃ§miÅŸi yÃ¼kle
                loadBadgeStatus(); // Rozet durumunu yÃ¼kle
            } else {
                window.location.href = '/login';
            }
        }

        function logout() {
            storage.remove('user');
            storage.remove('token');
            window.location.reload();
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            storage.set('theme', isDark ? 'dark' : 'light');
            checkAuth(); // Ä°konu gÃ¼ncellemek iÃ§in
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            sidebar.classList.toggle('hidden');
            if (!sidebar.classList.contains('hidden')) {
                sidebar.classList.add('fixed', 'inset-y-0', 'left-0', 'z-50', 'w-80', 'shadow-2xl', 'flex');
            } else {
                sidebar.classList.remove('fixed', 'inset-y-0', 'left-0', 'z-50', 'w-80', 'shadow-2xl', 'flex');
            }
        }

        // Ayarlar ModalÄ± Ä°ÅŸlemleri
        function openSettings() {
            const user = getSafeUser();
            if (user) {
                document.getElementById('settings-name').value = user.name;
                document.getElementById('settings-avatar').value = user.avatar || '';
            }
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('settings-error').classList.add('hidden');
        }

        // Rozet ve Check-in FonksiyonlarÄ±
        async function loadBadgeStatus() {
            const token = storage.get('token');
            if (!token) return;

            try {
                const res = await fetch('/api/badge-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                
                const data = await res.json();
                updateBadgeDisplay(data.streak, data.stars);

                // Check-in butonunu kontrol et
                const checkinBtn = document.getElementById('checkin-btn');
                const todayStr = new Date().toISOString().split('T')[0];
                if (data.lastCheckinDate && data.lastCheckinDate.startsWith(todayStr)) {
                    checkinBtn.disabled = true;
                    checkinBtn.innerHTML = '<i class="fa-solid fa-check-double mr-1"></i> Check-in YapÄ±ldÄ±';
                } else {
                    checkinBtn.disabled = false;
                    checkinBtn.innerHTML = '<i class="fa-solid fa-calendar-check mr-1"></i> GÃ¼nlÃ¼k Check-in';
                }

            } catch (err) {
                console.error("Rozet durumu yÃ¼klenemedi:", err);
            }
        }

        function updateBadgeDisplay(streak, stars, oldStars = -1) {
            const badgeEl = document.getElementById('discipline-badge');
            const streakEl = document.getElementById('badge-streak');
            const starsEl = document.getElementById('badge-stars');

            badgeEl.classList.remove('hidden');
            streakEl.textContent = streak;
            
            let starsHTML = '';
            for (let i = 1; i <= 4; i++) {
                const isFilled = i <= stars;
                const wasFilled = i <= oldStars;
                // Yeni bir yÄ±ldÄ±z kazanÄ±ldÄ±ysa animasyon sÄ±nÄ±fÄ±nÄ± ekle
                const animationClass = (isFilled && !wasFilled) ? 'star-upgraded' : '';
                starsHTML += `<i class="fa-solid fa-star ${isFilled ? 'text-amber-400' : 'text-gray-300 dark:text-gray-600'} ${animationClass}"></i>`;
            }
            starsEl.innerHTML = starsHTML;
        }

        async function handleCheckIn() {
            const token = storage.get('token');
            const btn = document.getElementById('checkin-btn');
            btn.disabled = true;

            try {
                const res = await fetch('/api/check-in', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                showToast(data.message || data.error);
                loadBadgeStatus(); // Check-in sonrasÄ± durumu tekrar yÃ¼kle
            } catch (err) {
                showToast("Bir hata oluÅŸtu.");
                btn.disabled = false;
            }
        }

        async function loadHistory() {
            const historyList = document.getElementById('history-list');
            if (!historyList) {
                console.error("Hata: 'history-list' ID'li element bulunamadÄ±.");
                return;
            }

            historyList.innerHTML = '<div class="p-4 text-sm text-gray-500">GeÃ§miÅŸ yÃ¼kleniyor...</div>';

            const token = storage.get('token');
            if (!token) {
                historyList.innerHTML = '<div class="p-4 text-sm text-gray-500">GeÃ§miÅŸi gÃ¶rmek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z.</div>';
                return;
            }

            try {
                const response = await fetch('/api/history', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({}) // Body'nin gÃ¶nderilmesi Ã¶nemli
                });
                const sessions = await response.json();
                
                // --- GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž HATA KONTROLÃœ ---
                if (!response.ok || (sessions && sessions.error)) {
                    const errorMessage = sessions.error || `Sunucu hatasÄ±: ${response.status}`;
                    console.error('GeÃ§miÅŸ yÃ¼klenirken sunucu hatasÄ±:', errorMessage);
                    historyList.innerHTML = `<div class="p-4 text-sm text-red-500">Hata: ${errorMessage}</div>`;
                    return;
                }

                if (!Array.isArray(sessions)) {
                    console.error('GeÃ§miÅŸ yÃ¼klenirken API\'den dizi formatÄ±nda veri gelmedi.', sessions);
                    historyList.innerHTML = '<div class="p-4 text-sm text-red-500">GeÃ§miÅŸ yÃ¼klenemedi (Format hatasÄ±).</div>';
                    return;
                }

                historyList.innerHTML = ''; // Listeyi temizle
                
                if (sessions.length === 0) {
                    historyList.innerHTML = '<div class="p-4 text-sm text-gray-500">HenÃ¼z bir sohbet geÃ§miÅŸiniz yok.</div>';
                    return;
                }

                // Gruplama MantÄ±ÄŸÄ±
                const groups = {
                    'BugÃ¼n': [],
                    'DÃ¼n': [],
                    'Bu Hafta': [],
                    'Daha Eski': []
                };

                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const yesterdayStart = todayStart - 86400000;
                const weekStart = todayStart - 6 * 86400000;

                sessions.sort((a, b) => b.id - a.id);

                sessions.forEach(session => {
                    if (session.id >= todayStart) groups['BugÃ¼n'].push(session);
                    else if (session.id >= yesterdayStart) groups['DÃ¼n'].push(session);
                    else if (session.id >= weekStart) groups['Bu Hafta'].push(session);
                    else groups['Daha Eski'].push(session);
                });

                Object.entries(groups).forEach(([label, groupSessions]) => {
                    if (groupSessions.length === 0) return;

                    const header = document.createElement('div');
                    header.className = 'text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 mt-4 px-3 sticky top-0 bg-white dark:bg-gray-800 py-1 z-10';
                    header.textContent = label;
                    historyList.appendChild(header);

                    groupSessions.forEach(session => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center group rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors pr-2';
                        div.innerHTML = `
                            <button onclick="loadSession(${session.id})" class="flex-1 text-left p-3 flex items-center gap-3 min-w-0">
                                <i class="fa-regular fa-message text-gray-400 group-hover:text-primary flex-shrink-0"></i>
                                <div class="truncate text-sm text-gray-600 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">${session.title}</div>
                            </button>
                            <button onclick="deleteSession(${session.id})" class="p-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        `;
                        historyList.appendChild(div);
                    });
                });

            } catch (err) {
                console.error("GeÃ§miÅŸ yÃ¼klenirken hata:", err);
                historyList.innerHTML = '<div class="p-4 text-sm text-red-500">GeÃ§miÅŸ yÃ¼klenirken bir aÄŸ hatasÄ± oluÅŸtu.</div>';
            }
        }

        function filterHistory() {
            const input = document.getElementById('history-search');
            const filter = input.value.toLowerCase();
            const historyList = document.getElementById('history-list');
            const children = Array.from(historyList.children);

            // 1. Ã–nce Ã¶ÄŸeleri filtrele
            children.forEach(child => {
                if (!child.classList.contains('text-xs')) {
                    const text = child.textContent || child.innerText;
                    child.style.display = text.toLowerCase().indexOf(filter) > -1 ? "" : "none";
                }
            });

            // 2. Sonra boÅŸ kalan baÅŸlÄ±klarÄ± gizle
            for (let i = 0; i < children.length; i++) {
                if (children[i].classList.contains('text-xs')) {
                    let visibleCount = 0;
                    // Bir sonraki baÅŸlÄ±ÄŸa kadar olan Ã¶ÄŸeleri kontrol et
                    for (let j = i + 1; j < children.length; j++) {
                        if (children[j].classList.contains('text-xs')) break;
                        if (children[j].style.display !== 'none') visibleCount++;
                    }
                    children[i].style.display = visibleCount > 0 ? "" : "none";
                }
            }
        }

        async function loadSession(sessionId) {
            const user = getSafeUser();
            const token = storage.get('token');
            if (!user || !token) return;

            try {
                const res = await fetch('/api/get-session', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ sessionId })
                });
                const session = await res.json();
                
                currentSessionId = session.id;
                messageHistory = []; // GeÃ§miÅŸi sÄ±fÄ±rla ve yeniden doldur
                chatContainer.innerHTML = ''; // EkranÄ± temizle
                
                session.messages.forEach(msg => {
                    appendMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                    messageHistory.push(msg);
                });
            } catch (err) {
                console.error("Seans yÃ¼klenirken hata:", err);
            }
        }

        async function deleteSession(sessionId) {
            const token = storage.get('token');
            if (!confirm("Bu oturumu silmek istediÄŸinizden emin misiniz?")) return;

            try {
                const res = await fetch('/api/delete-session', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ sessionId })
                });
                const data = await res.json();
                if (data.success) {
                    if (currentSessionId == sessionId) startNewChat();
                    loadHistory();
                }
            } catch (err) {
                console.error("Silme hatasÄ±:", err);
            }
        }

        function startNewChat() {
            currentSessionId = null;
            messageHistory = [];
            chatContainer.innerHTML = '';
            chatContainer.appendChild(welcomeScreen);
            welcomeScreen.classList.remove('hidden');
        }

        function useTemplate(text) {
            userInput.value = text;
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
            userInput.focus();
        }

        function copyToClipboard(btn, text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check text-green-500"></i>';
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                }, 2000);
            });
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR';
                window.speechSynthesis.speak(utterance);
            }
        }

        function toggleDictation() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Your browser does not support voice typing.");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            const micBtn = document.getElementById('mic-btn');
            
            recognition.lang = 'tr-TR';
            recognition.interimResults = false;

            recognition.onstart = function() {
                micBtn.classList.remove('text-gray-400');
                micBtn.classList.add('text-red-500', 'animate-pulse');
            };

            recognition.onend = function() {
                micBtn.classList.add('text-gray-400');
                micBtn.classList.remove('text-red-500', 'animate-pulse');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                userInput.value += (userInput.value ? ' ' : '') + transcript;
                userInput.style.height = 'auto';
                userInput.style.height = userInput.scrollHeight + 'px';
                userInput.focus();
            };

            recognition.start();
        }

        function exportChat() {
            if (messageHistory.length === 0) {
                alert("No chat history to export.");
                return;
            }

            let textContent = "LifeCoach AI - Chat History\n";
            textContent += "Date: " + new Date().toLocaleString() + "\n";
            textContent += "----------------------------------------\n\n";

            messageHistory.forEach(msg => {
                const role = msg.role === 'user' ? 'You' : 'LifeCoach AI';
                textContent += `[${role}]:\n${msg.content}\n\n`;
            });

            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sohbet-gecmisi-${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function sendFeedback(btn, type, messageContent) {
            const token = storage.get('token');
            if (!token || !currentSessionId) return;

            // GÃ¶rsel geri bildirim
            const parent = btn.parentElement;
            const buttons = parent.querySelectorAll('button');
            buttons.forEach(b => b.classList.remove('text-green-500', 'text-red-500', 'opacity-100')); // Reset
            
            btn.classList.add(type === 'like' ? 'text-green-500' : 'text-red-500', 'opacity-100');

            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        messageContent: messageContent,
                        feedback: type
                    })
                });
            } catch (err) {
                console.error("Feedback error:", err);
            }
        }

        // --- DOSYA Ä°ÅžLEME FONKSÄ°YONLARI ---
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentFile = {
                        data: e.target.result, // Base64 data URL
                        name: file.name,
                        type: file.type
                    };
                    
                    const container = document.getElementById('file-preview-container');
                    let previewHTML = '';
                    if (file.type.startsWith('image/')) {
                        previewHTML = `<img src="${currentFile.data}" class="h-16 w-auto rounded-md object-cover">`;
                    } else {
                        const iconClass = getFileIcon(file.name);
                        previewHTML = `<i class="${iconClass} text-3xl text-gray-500 dark:text-gray-400"></i>`;
                    }

                    container.innerHTML = `
                        ${previewHTML}
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800 dark:text-gray-100 truncate">${file.name}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${(file.size / 1024).toFixed(1)} KB</p>
                        </div>
                        <button onclick="clearFile()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md hover:bg-red-600 transition-colors">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;
                    container.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['pdf'].includes(ext)) return 'fa-solid fa-file-pdf';
            if (['doc', 'docx'].includes(ext)) return 'fa-solid fa-file-word';
            if (['xls', 'xlsx'].includes(ext)) return 'fa-solid fa-file-excel';
            if (['ppt', 'pptx'].includes(ext)) return 'fa-solid fa-file-powerpoint';
            return 'fa-solid fa-file';
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('file-preview-container').classList.add('hidden');
        }

        // --- DÃœÅžÃœNCE ZÄ°NCÄ°RÄ° (Reasoning) Ä°ÅžLEME ---
        function parseThinkingProcess(text) {
            // <think>...</think> etiketlerini bul ve ÅŸÄ±k bir detay kutusuna Ã§evir
            return text.replace(/<think>([\s\S]*?)<\/think>/g, (match, content) => {
                return `<details class="mb-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden group">
                    <summary class="cursor-pointer p-2 text-xs font-medium text-gray-500 hover:text-primary flex items-center gap-2 select-none">
                        <i class="fa-solid fa-brain text-primary/70"></i> DÃ¼ÅŸÃ¼nce SÃ¼reci (TÄ±kla)
                    </summary>
                    <div class="p-3 text-xs text-gray-600 dark:text-gray-400 font-mono border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 whitespace-pre-wrap">${content.trim()}</div>
                </details>`;
            });
        }

        // Markdown Resimlerini HTML'e Ã‡evir
        function parseMarkdownImages(text) {
            // !Alt Text formatÄ±nÄ± <img src="URL" alt="Alt Text"> formatÄ±na Ã§evirir
            return text.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" class="rounded-xl shadow-lg mt-3 mb-1 max-w-full h-auto border border-gray-200 dark:border-gray-700 block">');
        }

        function appendMessage(text, sender, animate = false) {
            if (!welcomeScreen.classList.contains('hidden')) {
                welcomeScreen.classList.add('hidden');
            }

            const isUser = sender === 'user';
            const div = document.createElement('div');
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in-up`;
            
            const user = getSafeUser();
            const userAvatar = (user && user.avatar) 
                ? `<img src="${user.avatar}" class="w-8 h-8 rounded-full object-cover order-2 ml-2">`
                : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center order-2 ml-2"><i class="fa-solid fa-user text-gray-500 text-xs"></i></div>`;

            const avatar = isUser 
                ? userAvatar
                : `<div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center order-1 mr-2"><i class="fa-solid fa-leaf text-white text-xs"></i></div>`;

            const actionBtns = !isUser ? `
                <div class="absolute -right-24 top-0 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white dark:bg-gray-800 p-1 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">
                    <button onclick="speakText('${escapeJS(text)}')" class="text-gray-400 hover:text-primary p-1" title="Read Aloud">
                        <i class="fa-solid fa-volume-high text-xs"></i>
                    </button>
                    <button onclick="copyToClipboard(this, '${escapeJS(text)}')" class="text-gray-400 hover:text-primary p-1" title="Copy">
                        <i class="fa-regular fa-copy text-xs"></i>
                    </button>
                    <button onclick="sendFeedback(this, 'like', '${escapeJS(text)}')" class="text-gray-400 hover:text-green-500 p-1" title="Like">
                        <i class="fa-regular fa-thumbs-up text-xs"></i>
                    </button>
                    <button onclick="sendFeedback(this, 'dislike', '${escapeJS(text)}')" class="text-gray-400 hover:text-red-500 p-1" title="Dislike">
                        <i class="fa-regular fa-thumbs-down text-xs"></i>
                    </button>
                </div>
            ` : '';

            const msgId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            // EÄŸer mesaj AI'dan geliyorsa ve animasyon yoksa (geÃ§miÅŸ yÃ¼kleniyorsa) veya animasyon bittiyse resimleri iÅŸle
            // AyrÄ±ca <think> etiketlerini iÅŸle
            let processedText = (!animate) ? parseMarkdownImages(text) : text;
            if (!isUser && !animate) {
                processedText = parseThinkingProcess(processedText);
            }

            const bubble = `
                <div class="max-w-[80%] md:max-w-[70%] ${isUser ? 'order-1' : 'order-2'} group relative">
                    ${actionBtns}
                    <div id="${msgId}" class="${isUser ? 'bg-primary text-white rounded-2xl rounded-tr-sm' : 'bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 text-gray-800 dark:text-gray-100 rounded-2xl rounded-tl-sm shadow-sm'} px-5 py-3.5 text-sm leading-relaxed whitespace-pre-wrap">
                        ${animate ? '' : processedText}
                    </div>
                    <div class="text-[10px] text-gray-400 mt-1 ${isUser ? 'text-right' : 'text-left'}">
                        ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
            `;

            div.innerHTML = avatar + bubble;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (animate) {
                typeWriter(text, msgId);
            }
        }

        function typeWriter(text, elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Metni kelimelere ve boÅŸluklara ayÄ±r (satÄ±r sonlarÄ±nÄ± koru)
            const parts = text.split(/(\s+)/);
            let i = 0;
            
            function type() {
                const el = document.getElementById(elementId);
                if (!el) return; // Element silindiyse dur
                
                if (i < parts.length) {
                    // EÄŸer parÃ§a bir resim linki iÃ§eriyorsa (basit kontrol)
                    // Not: Typewriter efekti sÄ±rasÄ±nda resmi parÃ§a parÃ§a yazmak yerine, 
                    // metin tamamlandÄ±ÄŸÄ±nda parse etmek daha saÄŸlÄ±klÄ±dÄ±r. 
                    // Ancak basitlik iÃ§in burada text node olarak ekliyoruz, 
                    // dÃ¶ngÃ¼ bittiÄŸinde HTML'i gÃ¼ncelleyeceÄŸiz.
                    el.appendChild(document.createTextNode(parts[i]));
                    i++;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    // GerÃ§ekÃ§i olmasÄ± iÃ§in rastgele gecikme (30ms - 70ms arasÄ±)
                    setTimeout(type, 30 + Math.random() * 40);
                }
            }
            type();
            
            // Yazma iÅŸlemi bittiÄŸinde (tahmini sÃ¼re) iÃ§eriÄŸi parse et
            setTimeout(() => {
                const el = document.getElementById(elementId);
                if(el) {
                    // Hem resimleri hem de dÃ¼ÅŸÃ¼nce balonlarÄ±nÄ± iÅŸle
                    el.innerHTML = parseThinkingProcess(parseMarkdownImages(text));
                }
            }, parts.length * 60 + 500);
        }

        function showTyping() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex w-full justify-start';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center mr-2">
                    <i class="fa-solid fa-leaf text-white text-xs"></i>
                </div>
                <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl rounded-tl-sm shadow-sm px-4 py-4 flex items-center gap-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        // Dinamik Prompt ÅžablonlarÄ±
        const templateOptions = [
            {
                title: "ðŸŒ… Sabah Rutini",
                desc: "GÃ¼ne enerjik baÅŸlamak iÃ§in stratejiler.",
                text: "Sabah rutinim nasÄ±l daha verimli hale getirebilirim? Bana bilimsel temelli Ã¶neriler ver."
            },
            {
                title: "ðŸš€ GiriÅŸim DesteÄŸi",
                desc: "Fikrini hayata geÃ§irmek iÃ§in ilk adÄ±mlar.",
                text: "Bir giriÅŸim fikrim var ama nereden baÅŸlayacaÄŸÄ±mÄ± bilmiyorum. MVP oluÅŸturma sÃ¼recinde bana rehberlik et."
            },
            {
                title: "ðŸ§  Duygusal Destek",
                desc: "BunalmÄ±ÅŸ hissettiÄŸinde konuÅŸ.",
                text: "BugÃ¼n kendimi Ã§ok yorgun ve tÃ¼kenmiÅŸ hissediyorum. DuygularÄ±mÄ± anlamama ve sakinleÅŸmeme yardÄ±m et."
            },
            {
                title: "ðŸ›¡ï¸ Red Team AracÄ±",
                desc: "Siber gÃ¼venlik iÃ§in Python scripti.",
                text: "Bana Python ile geliÅŸmiÅŸ bir Port Scanner (Red Team aracÄ±) yazar mÄ±sÄ±n? KodlarÄ± detaylÄ± aÃ§Ä±kla."
            },
            {
                title: "â³ Ertelemecilik",
                desc: "Odaklanma sorununu Ã§Ã¶z.",
                text: "SÃ¼rekli iÅŸlerimi erteliyorum. Disiplin kazanmak ve odaklanmak iÃ§in bana sert ama etkili bir yÃ¶ntem Ã¶ner."
            },
            {
                title: "ðŸ’¡ Kodlama Projesi",
                desc: "Backend yeteneklerini geliÅŸtir.",
                text: "AklÄ±ma proje fikri gelmiyor. Backend yeteneklerimi geliÅŸtirecek zorlu bir proje Ã¶ner ve temel yapÄ±sÄ±nÄ± kodla."
            },
            {
                title: "ðŸŽ¯ Hedef Belirleme",
                desc: "GerÃ§ekÃ§i hedefler koy.",
                text: "HayatÄ±mda bir yÃ¶n eksikliÄŸi hissediyorum. Bana 3 aylÄ±k, Ã¶lÃ§Ã¼lebilir ve gerÃ§ekÃ§i bir geliÅŸim planÄ± hazÄ±rla."
            },
            {
                title: "ðŸŽ¨ Resim OluÅŸtur",
                desc: "Hayal gÃ¼cÃ¼nÃ¼ gÃ¶rsele dÃ¶k.",
                text: "Bana siberpunk tarzÄ±nda, yaÄŸmurlu bir sokakta yÃ¼rÃ¼yen bir robot resmi Ã§iz."
            }
        ];

        function renderRandomTemplates() {
            const container = document.getElementById('dynamic-prompts');
            if (!container) return;

            // Diziyi karÄ±ÅŸtÄ±r ve ilk 2 tanesini al
            const shuffled = [...templateOptions].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 2);

            container.innerHTML = selected.map(t => `
                <button onclick="useTemplate('${t.text.replace(/'/g, "\\'")}')" class="p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:border-primary hover:bg-accent dark:hover:bg-gray-800 text-left transition-all group">
                    <span class="block font-medium text-gray-700 dark:text-gray-200 group-hover:text-primary mb-1">${t.title}</span>
                    <span class="text-sm text-gray-500">${t.desc}</span>
                </button>
            `).join('');
        }

        // Sayfa YÃ¼klendiÄŸinde BaÅŸlat
        document.addEventListener('DOMContentLoaded', () => {
            renderRandomTemplates();
            // Elementleri SeÃ§
            chatContainer = document.getElementById('chat-container');
            chatForm = document.getElementById('chat-form');
            userInput = document.getElementById('user-input');
            welcomeScreen = document.getElementById('welcome-screen');

            // Enter TuÅŸu Dinleyicisi
            if (userInput) {
                userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (chatForm) chatForm.requestSubmit();
                    }
                });
            }

            // Form GÃ¶nderim Dinleyicisi
            if (chatForm) {
                chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); // Sayfa yenilenmesini engelle
                    
                    const text = userInput.value.trim();
                    if (!text) return;

                    // User Message
                    let displayMessage = text;
                    if (currentFile) {
                        displayMessage += `\n\n[Dosya eklendi: ${currentFile.name}]`;
                    }
                    
                    appendMessage(displayMessage, 'user');
                    userInput.value = '';
                    userInput.style.height = 'auto';
                    const fileToSend = currentFile; // GÃ¶ndermek iÃ§in sakla
                    clearFile(); // UI'Ä± temizle

                    // Simulate AI Response
                    showTyping();
                    
                    // TarayÄ±cÄ± dilini otomatik algÄ±la (Ã–rn: 'tr-TR', 'en-US', 'de-DE')
                    const userLang = navigator.language || 'tr-TR';

                    const token = storage.get('token');

                    try {
                        const headers = { 'Content-Type': 'application/json' };
                        if (token) headers['Authorization'] = `Bearer ${token}`;

                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({
                                message: text,
                                history: messageHistory,
                                sessionId: currentSessionId,
                                userLanguage: userLang,
                                file: fileToSend // DosyayÄ± gÃ¶nder
                            })
                        });

                        const data = await response.json();
                        removeTyping();
                        
                        if (data.response) {
                            appendMessage(data.response, 'ai', true);
                            messageHistory.push({ role: 'user', content: text });
                            messageHistory.push({ role: 'assistant', content: data.response });
                            
                            // EÄŸer yeni bir seans baÅŸladÄ±ysa ID'yi gÃ¼ncelle ve listeyi yenile
                            if (!currentSessionId && data.sessionId) {
                                currentSessionId = data.sessionId;
                                loadHistory();
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        removeTyping();
                        appendMessage("Sorry, a connection error occurred.", 'ai');
                    }
                });
            }

            // Ayarlar Formu Dinleyicisi
            const settingsForm = document.getElementById('settings-form');
            if (settingsForm) {
                settingsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newName = document.getElementById('settings-name').value.trim();
                    const newAvatar = document.getElementById('settings-avatar').value.trim();
                    const errorMsg = document.getElementById('settings-error');
                    const user = getSafeUser();

                    if (!/^[a-zA-Z0-9_.]+$/.test(newName)) {
                        errorMsg.textContent = "Username can only contain letters, numbers, dots and underscores.";
                        errorMsg.classList.remove('hidden');
                        return;
                    }

                    try {
                        const res = await fetch('/api/update-profile', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: user.email, newName, newAvatar })
                        });
                        
                        const data = await res.json();

                        if (data.success) {
                            storage.set('user', JSON.stringify(data.user));
                            checkAuth();
                            closeSettings();
                        } else {
                            errorMsg.textContent = data.error;
                            errorMsg.classList.remove('hidden');
                        }
                    } catch (err) {
                        errorMsg.textContent = "An error occurred.";
                        errorMsg.classList.remove('hidden');
                    }
                });
            }

            // BaÅŸlangÄ±Ã§ Kontrolleri
            checkAuth();
        });
    </script>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-sm mx-4 shadow-2xl border border-gray-100 dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Edit Profile</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <form id="settings-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-400">@</span>
                        <input type="text" id="settings-name" class="pl-8 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm" placeholder="kullanici_adi">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Only letters, numbers, dots, and underscores allowed.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Avatar URL</label>
                    <input type="url" id="settings-avatar" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm" placeholder="https://example.com/avatar.jpg">
                    <p class="text-xs text-gray-500 mt-1">Optional: Paste an image link.</p>
                </div>
                <div id="settings-error" class="text-red-500 text-sm hidden"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeSettings()" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-xl hover:bg-teal-800 font-medium transition-colors">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>
</body>
</html>