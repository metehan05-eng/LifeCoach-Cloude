<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - LifeCoach AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#0F766E' } }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans min-h-screen flex items-center justify-center">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 space-y-8 border border-gray-100">
        <div class="text-center">
            <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl">
                <i class="fa-solid fa-key"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 tracking-tight">Reset Password</h2>
            <p class="mt-2 text-sm text-gray-600" id="page-desc">Enter your email to receive a PIN code.</p>
        </div>

        <!-- STEP 1: EMAIL -->
        <form id="step-email" class="space-y-6">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
            </div>
            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-primary hover:bg-teal-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all">
                Send PIN Code
            </button>
        </form>

        <!-- STEP 2: PIN VERIFICATION -->
        <form id="step-pin" class="space-y-6 hidden">
            <div>
                <label for="pin" class="block text-sm font-medium text-gray-700">Enter 6-Digit PIN</label>
                <input type="text" id="pin" maxlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm tracking-widest text-center text-lg">
            </div>
            
            <div class="text-center">
                <div class="text-sm font-medium text-gray-600 mb-2">Time Remaining</div>
                <div id="timer" class="text-2xl font-bold text-primary">03:00</div>
            </div>

            <button type="button" id="verify-pin-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-primary hover:bg-teal-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all">
                Verify PIN
            </button>

            <button type="button" id="resend-btn" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-xl shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none transition-all hidden">
                Resend PIN
            </button>
        </form>

        <!-- STEP 3: NEW PASSWORD -->
        <form id="step-password" class="space-y-6 hidden">
            <div>
                <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                <input type="password" id="new-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
            </div>
            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-primary hover:bg-teal-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all">
                Update Password
            </button>
        </form>

        <div id="message-box" class="text-sm text-center hidden p-3 rounded-lg"></div>

        <div class="text-center text-sm text-gray-600">
            <a href="/login" class="font-medium text-primary hover:text-teal-800">Back to Login</a>
        </div>
    </div>

    <script>
        let userEmail = '';
        let timerInterval;

        const messageBox = document.getElementById('message-box');
        
        function showMessage(msg, type) {
            messageBox.textContent = msg;
            messageBox.className = `text-sm text-center p-3 rounded-lg ${type === 'error' ? 'text-red-700 bg-red-50' : 'text-green-700 bg-green-50'}`;
            messageBox.classList.remove('hidden');
        }

        function startTimer() {
            let timeLeft = 180; // 3 dakika
            const timerDisplay = document.getElementById('timer');
            const resendBtn = document.getElementById('resend-btn');
            
            resendBtn.classList.add('hidden');
            clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "00:00";
                    showMessage("PIN expired. Please resend.", "error");
                    resendBtn.classList.remove('hidden');
                }
                timeLeft--;
            }, 1000);
        }

        // STEP 1: Send PIN
        document.getElementById('step-email').addEventListener('submit', async (e) => {
            e.preventDefault();
            userEmail = document.getElementById('email').value;
            
            try {
                const res = await fetch('/api/send-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('step-email').classList.add('hidden');
                    document.getElementById('step-pin').classList.remove('hidden');
                    document.getElementById('page-desc').textContent = `PIN sent to ${userEmail}. Check console/email.`;
                    startTimer();
                    showMessage("PIN sent successfully!", "success");
                } else {
                    showMessage(data.error, "error");
                }
            } catch (err) { showMessage("Connection error.", "error"); }
        });

        // Resend PIN
        document.getElementById('resend-btn').addEventListener('click', () => {
            document.getElementById('step-email').dispatchEvent(new Event('submit'));
        });

        // STEP 2: Verify PIN (Client side check -> Move to Step 3)
        document.getElementById('verify-pin-btn').addEventListener('click', () => {
            const pin = document.getElementById('pin').value;
            if (pin.length !== 6) return showMessage("Please enter a 6-digit PIN.", "error");
            
            // PIN'i sunucuda doğrulamak yerine son adımda hepsini birden gönderiyoruz
            // Ancak kullanıcı deneyimi için burada arayüzü değiştiriyoruz
            document.getElementById('step-pin').classList.add('hidden');
            document.getElementById('step-password').classList.remove('hidden');
            document.getElementById('page-desc').textContent = "Set your new password.";
            showMessage("", "success"); // Mesajı temizle
            messageBox.classList.add('hidden');
        });

        // STEP 3: Reset Password
        document.getElementById('step-password').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pin = document.getElementById('pin').value;
            const newPassword = document.getElementById('new-password').value;

            try {
                const res = await fetch('/api/reset-password-confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, pin, newPassword })
                });
                
                const data = await res.json();

                if (data.success) {
                    showMessage("Password updated! Redirecting...", "success");
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    // Hata varsa (örn: PIN yanlış), geri PIN ekranına dönülebilir veya hata gösterilir
                    showMessage(data.error, "error");
                    if (data.error.includes("PIN")) {
                        document.getElementById('step-password').classList.add('hidden');
                        document.getElementById('step-pin').classList.remove('hidden');
                    }
                }
            } catch (err) { showMessage("An error occurred.", "error"); }
        });
    </script>
</body>
</html>